<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <style>

  body {
    background: #E0E0E0;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .axis text {
    font: 10px sans-serif;
  }

  .cells path {
    fill: none;
    pointer-events: all;
  }

  .cells :hover circle {
    fill: red;
  }
  g.gridlines.axis--x path{
    stroke: none;
  }

  .gridlines line{
    stroke: #424242;
    stroke-width: .8px;
    stroke-opacity: 0.4;
  }

  g.axis.axis--x path{
    stroke: none;
  }

  g.axis.axis--x line{
    stroke: none;
    stroke-width: 1px;
  }

  g.axis.axis--x g text{
    font-size: 10px;
    font-family: 'Inconsolata', monospace;
  }

  g.axis.axis--x text.label{
    font-size: 12p  x;
    font-family: 'Inconsolata', monospace;
  }
  </style>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.0/css/ion.rangeSlider.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.0/js/ion.rangeSlider.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.bootstrap3.min.css" rel="stylesheet">
</head>
<body>
  <div>
  <input type="text" id="indOneMinMax" name="indicatorOne_range" value="" />
  </div>
  <div>
    <select id="team-selector">
      <option value="volvo">Volvo</option>
    </select>
  </div>
  <div>
    <div><input type="radio" name="type" value="All" checked="checked">All</div>
    <div><input type="radio" name="type" value="Batsman">Batsmen</div>
    <div><input type="radio" name="type" value="Allrounder">All-Rounder</div>
    <div><input type="radio" name="type" value="Bowler">Bowler</div>
  </div>
  <svg width="1200" height="800"></svg>
  <script>
// define svg and dimensions of chart
const svg = d3.select("svg"),
    margin = {top: 40, right: 40, bottom: 40, left: 40},
    SVGWidth = svg.attr("width"),
    SVGHeight = svg.attr("height"),
    width = SVGWidth - margin.left - margin.right,
    height = SVGHeight - margin.top - margin.bottom;

// function to get half century units from data
// voronoi (logical) indicates if voronoi function has been applied to data
function getHCUnits(d, voronoi) {
  let centuries = voronoi ? d.data.Centuries : d.Centuries;
  let halfCenturies = voronoi ? d.data.HalfCenturies : d.HalfCenturies;
  return halfCenturies + 2 * (centuries);
}


// defining all relevant scales

// batting average across x
let x = d3.scaleLinear()
    .range([0, width]);
// radius mapped to strike rate
let radScale = d3.scaleSqrt()
                .range([5, 15])
// stroke colored to team and sized proportional to radius
let strokeScale = d3.scaleSqrt()
                .range([1, 4])
// an outline outside circle to denote half centuries
let centuryScale = d3.scaleSqrt()
                .range([0, 4])
// categorical scale for team colors
let colScale = d3.scaleOrdinal()
                  .domain(['Peshawar Zalmi', 'Islamabad United', 'Quetta Gladiators', 'Lahore Qalandars', 'Karachi Kings', 'Multan Sultans'])
                  .range(['#FFFF00','#FF6F00', '#4A148C','#B71C1C', '#004D40', '#212121']);

function drawBeeswarm(data){
    const g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    const defs = svg.selectAll("defs")
      .data(data)
      .enter()
      .append("defs")

    defs.append("pattern")
      .attr('id', d => d.id)
      .attr('height', '100%')
      .attr('width', '100%')
      .attr("patternContentUnits", "objectBoundingBox")
      .append("image")
      .attr('height', 1)
      .attr('width', 1)
      .attr('preserveAspectRatio', 'none')
      .attr("xlink:href", d => d.photoLink);

    x.domain(d3.extent(data, function(d) { return +d.Avg; }));
    radScale.domain(d3.extent(data, function(d) { return +d.SR; }));
    strokeScale.domain(d3.extent(data, function(d) { return +d.SR; }));
    centuryScale.domain(d3.extent(data, function(d) { return getHCUnits(d, false); }))

    let simulation = d3.forceSimulation(data)
        .force("x", d3.forceX(function(d) { return x(+d.Avg); }).strength(5))
        .force("y", d3.forceY(height / 2))
        .force("collision", d3.forceCollide().radius(d => radScale(d.SR) + strokeScale(d.SR) /*+ centuryScale(getHCUnits(d, false))*/))
        .stop();

    // complete force simulation to get to equilibrium
    for (var i = 0; i < 500; ++i) simulation.tick();

    g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x).tickValues(d3.range(0, 50, 5)))

    g.select(".axis.axis--x")
      .append('text')
      .attr('class', 'label axis --x')
      .text('Batting Average')
      .style('text-anchor', 'start')
      .style('fill', 'black')
      .attr('transform', 'translate(0, 12)');



    const xGridlines = d3.axisBottom()
                        .scale(x)
                        .tickSize(height)
                        .tickFormat("")

    g.append("g")
      .attr("class", "gridlines axis--x")
      .call(xGridlines);

    d3.selectAll('g.axis.axis--x g text')
      .attr('transform', 'translate(10, -18)')


    data = data.filter(d => !isNaN(d.Avg))


    let voronoi = d3.voronoi()
                    .extent([[-margin.left,  -margin.top], [width + margin.right, height + margin.top]])
                    .x(function(d) { return d.x; })
                    .y(function(d) { return d.y; })

    let cell = g.append("g")
        .attr("class", "cells")
        .selectAll("g")
        .data(voronoi.polygons(data))
        .enter()
        .append("g");

    cell.append("circle")
        .attr('class', 'centuries')
        .attr("r", d => radScale(d.data.SR) + (strokeScale(d.data.SR)/2) + centuryScale(getHCUnits(d, true)))
        .attr("cx", function(d) { return d.data.x; })
        .attr("cy", function(d) { return d.data.y; })
        //.style('fill', d => colScale(d.data.Team))
        .style("fill", 'grey')
        .style("fill-opacity", 0.2)
        .style('stroke', 'black')
        .style("stroke-width", d => {
          if (d.data.Centuries > 0 || d.data.HalfCenturies > 0){
            return .5
          }
          else {
            return 0
          }
        })
        .style('stroke-opacity', 0.6)

    cell.append("circle")
        .attr('class', 'team-strikeRate')
        .attr("r", d => radScale(d.data.SR))
        .attr("cx", function(d) { return d.data.x; })
        .attr("cy", function(d) { return d.data.y; })
        //.style('fill', d => colScale(d.data.Team))
        .style("fill", d => `url(#${d.data.id})`)
        .style('stroke', d => colScale(d.data.Team))
        .style("stroke-width", d => strokeScale(d.data.SR) + "px")


    cell.append("path")
        .attr("d", function(d) { return "M" + d.join("L") + "Z"; });

    console.log(cell);
    tCell = cell;

    /*cell.append("title")
        .text(function(d) { return d.data.Name + "\n" + d.data.Avg + "\n" + d.data.SR; });*/
}

function preProcssData(data){
  data.forEach(d => {
    d.photoLink = `photos/${d.Name}.jpg`
    d.id = d.Name.replace(/ /g, "");
  })
}

function FilterModule(){
  class Filter {
    constructor(fn, name){
      this._fn = fn;
      this.name = name;
    }

    apply(selection){
      return selection.filter(this._fn);
    }
  }

  class FilterSequence{
    constructor(){
      this.filters = [];
    }

    add(filter){
      var index = this.filters.findIndex((d)=>d.name === filter.name);

      if(index > -1){
        this.filters[index] = filter;
      }else{
        this.filters.push(filter);
      }
    }

    remove(name){
      var index = this.filters.findIndex((d)=>d.name === name);
      if(index === -1){
        return;
      }
      this.filters.splice(index,1);
    }

    execute(selection){
      return this.filters.reduce(function(acc,d){
        return d.apply(acc);
      }, selection);
    }

    removeAll(){
      this.filters = [];
    }
  }

  return {
    Filter : Filter,
    FilterSequence : FilterSequence
  };
}

function domFilterModule({
  selectionString,
  filterOutTransitionFunc = function(selection){
    return selection.transition()
      .duration(100)
      .delay((d,i)=> i * 5 * Math.random())
      .attr('r', 0)
      .style('opacity', 0);
  },
  filterInTransitionFunc = function(selection){
    return selection.transition()
      .duration(100)
      .delay((d,i)=> i * 2 * Math.random())
      .attr('r', (d)=>d.originalRadius)
      .style('opacity', 1);
  },
  getDataObjFunc = function(d){
    return  d;
  }
}={}){

  var filterModule = FilterModule();

  var filterSeq = new filterModule.FilterSequence();

  testFS = filterSeq;

  function addNumericFilter(min,max,ind){
    var filterFunc = (d)=>{
      var dataObj = getDataObjFunc(d);
      var val = parseFloat(dataObj[ind]);
      return val >= min && val <= max;
    };

    var filter = new filterModule.Filter(filterFunc, ind);
    filterSeq.add(filter);
  }

  function addOrdinalFilter(matches,ind){
    var filterFunc = (d)=>{
      var dataObj = getDataObjFunc(d);
      var val = dataObj[ind];
      return matches[val];
    };

    var filter = new filterModule.Filter(filterFunc, ind);
    filterSeq.add(filter);
  }

  function addCustomFilter(filterFunc,ind){
    var filter = new filterModule.Filter(filterFunc, ind);
    filterSeq.add(filter);
  }

  function removeFilter(name){
    filterSeq.remove(name);
  }

  function removeAllFilters(){
    filterSeq.removeAll();

    /*svg.selectAll(selectionString)
      .classed('c-filter-show', false)
      .transition()
      .duration(300)
      .delay((d,i)=> i * 5 * Math.random())
      .attr('r', (d)=>d.originalRadius)
      .style('opacity', 1)*/
  }

  function executeFilter(){

    //remove filter class
    /*svg.selectAll('.g-circles circle')
      .classed('c-filter-show', false);*/

    selection = filterSeq.execute(d3.selectAll(selectionString));

    //show all that were previosly filtered
    //console.log(selection);

    var filterIn = selection.filter(function(){
        return !this.classList.contains('c-filter-show');
      })
      .style('display','unset');
      //.call(filterInTransitionFunc)

    filterInTransitionFunc(filterIn)
      /*.on('end', function(){
        
      })*/

    //set not filtered class
    svg.selectAll(selectionString)
      .classed('c-filter-show', false);

    selection.classed('c-filter-show', true);

    //remove all filtered
    var filterOut = svg.selectAll(selectionString + ':not(.c-filter-show)')
      .classed('c-filter-show', false)
      //.call(filterOutTransitionFunc)

    filterOutTransitionFunc(filterOut)
      .on('end', function(){
        this.style.display = 'none';
      })

    return selection;
  }

  return {
    addNumericFilter : addNumericFilter,
    addOrdinalFilter : addOrdinalFilter,
    addCustomFilter : addCustomFilter,
    executeFilter : executeFilter,
    removeAllFilters : removeAllFilters,
    removeFilter : removeFilter
  }
}

async function readAndDrawBeeswarm(){
  let data = await d3.csv('PSL_Batting.csv')
  tData = data;

  // add ids and photo links
  preProcssData(data);

  drawBeeswarm(data);

  initSelectize('#team-selector', getTeams(tData), function(e){
    var val = e.target.value;
    if(val === 'All'){
      filterCTRL.removeFilter('Team');
    }else{
      var matches = {};
      matches[val] = true;
      filterCTRL.addOrdinalFilter(matches, 'Team');
    }
    filterCTRL.executeFilter();
  });

  initRadioButtons();
}

function getTeams(data){
  var teams = {};

  data.forEach(function(d){
    teams[d.Team] = true;
  });

  return Object.keys(teams).map((d)=>{return {name : d, text : d, value : d}});
}

readAndDrawBeeswarm();

var filterCTRL = domFilterModule({
  selectionString : 'svg g.cells g',
  getDataObjFunc : function(d){
    return d.data;
  },
  /*filterOutTransitionFunc : function(selection){
    return selection.transition()
      .duration(100)
      .delay((d,i)=> i * 5 * Math.random())
      .attr('r', 0)
      .style('opacity', 0);
  }*/
});

$("#indOneMinMax").ionRangeSlider({
  type: "double",
  grid: true,
  min: 0,
  max: 50,
  from: 0,
  to: 50,
  onChange : function(data){
    filterCTRL.addNumericFilter(data.from, data.to, 'Avg');
    filterCTRL.executeFilter();
  }
});

function initSelectize(selector,options, cb){

  var el = $(selector);

  options.push({name : 'All', text : 'All', value : 'All'});
  el.selectize({
    sortField : 'text',
    options : options
  });

  el[0].selectize.setValue('All', true);

  el.on('change', function(e){

    var selected = e.target.value;

    if(!selected){
      return;
    }
    cb(e);
  });
}


function initRadioButtons(){
  $('input[type="radio"][name="type"]').on('click', function(e){
    var val = e.target.value;

    if(val === 'All'){
      filterCTRL.removeFilter('TypeA');
    }else{
      var matches = {};
      matches[val] = true;
      filterCTRL.addOrdinalFilter(matches, 'TypeA');
    }

    filterCTRL.executeFilter();
  })
}

  </script>
</body>